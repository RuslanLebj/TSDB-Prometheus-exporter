
# TSDB Prometheus Exporter

Этот проект предоставляет простой HTTP-экспортер системных метрик (CPU, память, дисковое пространство) для Prometheus.

---

## Описание

Экспортер собирает метрики системы и предоставляет их в формате, совместимом с Prometheus, через HTTP. Метрики включают:
- Процент использования CPU
- Общий объем оперативной памяти
- Используемую оперативную память
- Общий объем дискового пространства
- Используемое дисковое пространство

---

## Установка

1. Клонируйте репозиторий:
   ```bash
   git clone <repository_url>
   cd <repository_directory>
   ```

2. Установите зависимости:
   ```bash
   poetry install
   ```

3. Создайте файл `.env` для настройки хоста и порта или скопируйте `template.env`:
   ```env
   EXPORTER_HOST=0.0.0.0
   EXPORTER_PORT=8081
   ```

---

## Запуск экспортера

Запустите экспортер с помощью Python:
```bash
python main.py
```

Экспортер будет запущен на указанном хосте и порту (по умолчанию `http://0.0.0.0:8081`).

## Запуск Prometheus в Docker контейнере

Запустите Prometheus с помощью команды
```bash
docker-compose up -d
```

Prometheus будет запущен на `http://localhost:8081`.

---
## Запросы
**PromQL-запросы:** 
- Использование процессора (в процентах):
```
cpu_usage
```

- Всего памяти (в байтах):
```
memory_total
```

- Используемая память (в байтах):
```
memory_used
```

- Всего дискового пространства (в байтах):
```
disk_total
```
- Используемое дисковое пространство (в байтах):
```
disk_used
```

---

## Почему на Linux требуется IP-адрес хоста?

### Linux:
На Linux Docker использует сетевой драйвер **bridge** по умолчанию, который создает отдельную виртуальную сеть для контейнеров. В этой сети `localhost` внутри контейнера указывает на сам контейнер, а не на хостовую машину. Поэтому для подключения Prometheus к экспортеру необходимо использовать реальный IP-адрес хоста (например, `192.168.0.35`).

### Windows/Mac:
На Windows и Mac Docker автоматически создает специальный адрес `host.docker.internal`, который позволяет контейнерам обращаться к хосту. Поэтому в этих системах достаточно указать `localhost` или `host.docker.internal`.

---

## Пример конфигурации для разных ОС

### Для Linux:
```yaml
static_configs:
  - targets: [ '192.168.0.35:8081' ]  # Укажите IP хоста
```

### Для Windows/Mac:
```yaml
static_configs:
  - targets: [ 'localhost:8081' ]  # Или используйте host.docker.internal
```

---

## Проверка

1. Убедитесь, что экспортер работает:
   ```bash
   curl http://<host>:8081
   ```
   Вы должны увидеть метрики в формате Prometheus.

2. Убедитесь, что Prometheus видит экспортера:
   Перейдите на страницу `http://<prometheus_host>:9090/targets` и убедитесь, что цель `exporter` отображается со статусом **UP**.

## Примечение
Я тестировал работу на системе `Ubuntu` c параметрами:
`.env`:
```bash
EXPORTER_HOST=0.0.0.0
EXPORTER_PORT=8081
```

и
 `prometheus.yml`:
```yaml
global:
  scrape_interval: 15s  # Опрос метрик каждые 15 секунд

scrape_configs:
  - job_name: 'exporter'
    metrics_path: '/'  # Путь, по которому Prometheus будет запрашивать метрики
    static_configs:
#      - targets: [ 'localhost:8081' ] # Ваш экспортер (На Linux необходимо использовать IP хоста вместо localhost, см. README)
      - targets: [ '192.168.0.35:8081' ]
```